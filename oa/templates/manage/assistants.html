{% extends "manage/base_manage.html" %}


{% block title %}Assistants - {{ SITE_NAME }}{% endblock %}


{% block content %}{{ block.super }}

{% with active='assistants' %}
    {% include "manage/nav.html" %}
{% endwith %}

<div class="container mt-4 mb-4">
    <!-- Assistants Table -->
    <div id="assistants-container" class="my-4">
        {% include 'partials/loading_indicator.html' with content_id='assistants' content_name='assistants' %}
        <div class="row">
            <div class="col-3">
                <ul class="nav nav-pills flex-column" role="tablist" id="assistantTabs">
                </ul>
            </div>
            <div class="col-9">
                <div class="tab-content" id="assistantContent">
                </div>
            </div>
        </div>
        <div id="no-assistants" class="text-center text-secondary d-none">
            <p>No assistants available.</p>
            <span class="text-secondary">
                You can create assistants <a href="{% url "manage_overview" project_uuid=selected_project.uuid %}" class="text-decoration-none">here</a>.
            </span>
        </div>

    </div>
</div>

{% endblock %}


{% block extra_scripts %}{{ block.super }}
<script>
    /* Assistants */

    async function fetchAssistants() {
        try {
            const assistantsResponse = await fetch("{% url 'api-1.0.0:list_assistants' %}", {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${API_KEY}`,
                    'Content-Type': 'application/json',
                }
            });

            const assistantsData = await assistantsResponse.json();
            
            console.log('assistants:', assistantsData);

            populateTabsAndContent(assistantsData.assistants);

        } catch (error) {
            console.error('Error fetching assistants:', error);
        } finally {
            toggleLoading('assistants', false);
        }
    }

    function populateTabsAndContent(assistants) {
        const tabsContainer = document.getElementById('assistantTabs');
        const contentContainer = document.getElementById('assistantContent');

        tabsContainer.innerHTML = '';
        contentContainer.innerHTML = '';

        if (!assistants || assistants.length === 0) {
            document.getElementById('no-assistants').classList.remove('d-none');
            return;
        }

        assistants.forEach((assistant, index) => {
            const tabItem = document.createElement('li');
            tabItem.className = 'nav-item';

            const tabLink = document.createElement('a');
            tabLink.className = index === 0
                ? 'nav-link py-1 px-2 bg-secondary text-white active'
                : 'nav-link py-1 px-2 bg-white text-secondary';
            tabLink.setAttribute('data-bs-toggle', 'tab');
            tabLink.setAttribute('href', `#assistant-${assistant.id}`);
            tabLink.setAttribute('role', 'tab');
            tabLink.setAttribute('aria-controls', `assistant-${assistant.id}`);
            tabLink.setAttribute('aria-selected', index === 0 ? 'true' : 'false');
            tabLink.id = `assistant-${assistant.id}-tab`;
            tabLink.textContent = assistant.name || 'Untitled Assistant';

            tabItem.appendChild(tabLink);
            tabsContainer.appendChild(tabItem);

            const contentPane = document.createElement('div');
            contentPane.className = `tab-pane fade ${index === 0 ? 'show active' : ''}`;
            contentPane.setAttribute('id', `assistant-${assistant.id}`);
            contentPane.setAttribute('role', 'tabpanel');
            contentPane.setAttribute('aria-labelledby', `assistant-${assistant.id}-tab`);

            contentPane.innerHTML = `
                <h4>${assistant.name || 'Untitled Assistant'}</h4>
                <p><strong>Model:</strong> ${assistant.model}</p>
                <p><strong>Tools:</strong> ${assistant.tools.map(tool => tool.type).join(', ') || 'None'}</p>
                <div id="stats-${assistant.id}"></div>
            `;

            contentContainer.appendChild(contentPane);

        });

        // Listen for tab activation events so we can update the background classes
        document.querySelectorAll('#assistantTabs a[data-bs-toggle="tab"]').forEach(tab => {
            tab.addEventListener('shown.bs.tab', function (event) {
                // Loop through all tabs and update classes accordingly
                document.querySelectorAll('#assistantTabs a[data-bs-toggle="tab"]').forEach(t => {
                    if (t === event.target) {
                        t.classList.remove('bg-white', 'text-secondary');
                        t.classList.add('bg-secondary', 'text-white');
                    } else {
                        t.classList.remove('bg-secondary', 'text-white');
                        t.classList.add('bg-white', 'text-secondary');
                    }
                });
            });
        });
    }

    /* Initialize Page */

    async function initializePage() {
        toggleLoading('assistants', true);
        fetchAssistants();
    }

    initializePage();

</script>
{% endblock %}
