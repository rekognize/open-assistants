<script>
    /* Assistants */

    async function fetchAssistantsTab() {
        toggleLoading('loadingAssistantsTab', true);
        try {
            // Wait until assistants are loaded or an error occurs
            while (!assistantsLoaded) {
                if (assistantsError) {
                    throw new Error(assistantsError);
                }
                await new Promise(resolve => setTimeout(resolve, 100));
            }

            populateAssistantsTabsAndContent(assistants);

        } catch (error) {
            const contentContainer = document.getElementById('assistants-tab-container');
            contentContainer.innerHTML = `
                <div class="text-center text-danger">Failed to load assistants!</div>
            `;
        } finally {
            toggleLoading('loadingAssistantsTab', false);
        }
    }

    function populateAssistantsTabsAndContent(assistants) {
        const tabsContainer = document.getElementById('assistantsNavTabs');
        const contentContainer = document.getElementById('assistantContent');

        tabsContainer.innerHTML = '';
        contentContainer.innerHTML = '';

        // Check if the global dict is empty
        if (!assistants || Object.keys(assistants).length === 0) {
            document.getElementById('no-assistants').classList.remove('d-none');
            return;
        }

        // Convert the assistants object into an array of assistant objects
        const assistantsArr = Object.values(assistants);

        assistantsArr.forEach((assistant, index) => {
            const tabItem = document.createElement('li');
            tabItem.className = 'nav-item';

            const tabLink = document.createElement('a');
            tabLink.className = index === 0
                ? 'nav-link py-1 px-2 bg-secondary text-white active'
                : 'nav-link py-1 px-2 bg-white text-secondary';
            tabLink.setAttribute('data-bs-toggle', 'tab');
            tabLink.setAttribute('href', `#assistants-tab-${assistant.id}`);
            tabLink.setAttribute('role', 'tab');
            tabLink.setAttribute('aria-controls', `assistants-tab-${assistant.id}`);
            tabLink.setAttribute('aria-selected', index === 0 ? 'true' : 'false');
            tabLink.id = `assistants-tab-${assistant.id}-tab`;
            tabLink.textContent = assistant.name || 'Untitled Assistant';

            tabItem.appendChild(tabLink);
            tabsContainer.appendChild(tabItem);

            const contentPane = document.createElement('div');
            contentPane.className = `tab-pane fade ${index === 0 ? 'show active' : ''}`;
            contentPane.setAttribute('id', `assistants-tab-${assistant.id}`);
            contentPane.setAttribute('role', 'tabpanel');
            contentPane.setAttribute('aria-labelledby', `assistants-tab-${assistant.id}-tab`);

            // Get folder names for the assistant
            const folderNames = (assistantFoldersMapping && assistantFoldersMapping[assistant.id]
                ? assistantFoldersMapping[assistant.id]
                      .map(uuid => folders[uuid] ? folders[uuid].name : null)
                      .filter(name => name)
                      .join(', ')
                : `<span>No folders assigned</span>`);

            // Set the inner HTML
            contentPane.innerHTML = `
                <div class="card border-0">

                    <div class="card-body pt-0" id="tab-card-${assistant.id}">

                        <div class="d-flex justify-content-between align-items-center">
                            <h4 class="card-title">${assistant.name || 'Untitled Assistant'}</h4>
                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="#">
                                <i class="bi bi-pencil"></i> Edit
                            </button>
                        </div>
                        <p class="text-secondary small">
                            Created: ${formatUnixTimestamp(assistant.created_at)}
                            (${timeSince(assistant.created_at * 1000)} ago)
                        </p>

                        <div class="accordion mt-4" id="foldersAccordion-${assistant.id}">
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="heading-${assistant.id}">
                                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${assistant.id}" aria-expanded="false" aria-controls="collapse-${assistant.id}">
                                        <span class="text-secondary small">Folders</span>
                                    </button>
                                </h2>
                                <div id="collapse-${assistant.id}" class="accordion-collapse collapse show" aria-labelledby="heading-${assistant.id}" data-bs-parent="#foldersAccordion-${assistant.id}">
                                    <div class="accordion-body d-flex justify-content-between align-items-center">
                                        ${folderNames}
                                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="#">
                                            Manage
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="info-box mt-4">
                            <span class="info-label">Description</span>
                            <p class="info-value" id="info-description-${assistant.id}">${assistant.description || 'No description given'}</p>
                        </div>

                        <div class="info-box mt-4">
                            <span class="info-label">Instructions</span>
                            <p class="info-value" id="info-instructions-${assistant.id}">${assistant.instructions || 'No instructions'}</p>
                        </div>

                        <div class="info-box mt-4">
                            <span class="info-label">Model</span>
                            <p class="info-value" id="info-model-${assistant.id}">${assistant.model}</p>
                        </div>
                    </div>
                </div>
            `;

            contentContainer.appendChild(contentPane);

        });

        // Listen for tab activation events so we can update the background classes
        document.querySelectorAll('#assistantsNavTabs a[data-bs-toggle="tab"]').forEach(tab => {
            tab.addEventListener('shown.bs.tab', function (event) {
                // Loop through all tabs and update classes accordingly
                document.querySelectorAll('#assistantsNavTabs a[data-bs-toggle="tab"]').forEach(t => {
                    if (t === event.target) {
                        t.classList.remove('bg-white', 'text-secondary');
                        t.classList.add('bg-secondary', 'text-white');
                    } else {
                        t.classList.remove('bg-secondary', 'text-white');
                        t.classList.add('bg-white', 'text-secondary');
                    }
                });
            });
        });
    }
</script>
