<script>
  // Global variables to hold fetched data
  let allFiles = [];
  let allFolders = [];

  async function fetchFiles() {
    const url = "{% url 'api-1.0.0:list_files' %}";
    try {
      const response = await fetch(url, {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${API_KEY}`,
          'Content-Type': 'application/json',
        }
      });
      return await response.json();
    } catch (error) {
      console.error('Error fetching files:', error);
    }
  }

  async function fetchFolders() {
    const url = "{% url 'folders-api:list_folders' %}";
    try {
      const response = await fetch(url, {
        method: 'GET',
        headers: {
          'Authorization': `Bearer ${API_KEY}`,
          'Content-Type': 'application/json',
        }
      });
      return await response.json();
    } catch (error) {
      console.error('Error fetching folders:', error);
    }
  }

  // Fetch both folders and files, then build the UI
  async function fetchFoldersTab() {
    toggleLoading('loadingFoldersTab', true);
    const foldersData = await fetchFolders();
    const filesData = await fetchFiles();
    toggleLoading('loadingFoldersTab', false);

    // Assume responses include .folders and .files arrays
    allFolders = foldersData.folders;
    allFiles = filesData.files;

    populateFoldersTabsAndContent(allFolders, allFiles);
  }

  // Build folder tabs and for each, display a dual-list widget with filter input and scrollable lists.
  function populateFoldersTabsAndContent(folders, files) {
    const tabsContainer = document.getElementById('foldersNavTabs');
    const contentContainer = document.getElementById('folderContent');

    tabsContainer.innerHTML = '';
    contentContainer.innerHTML = '';

    if (!folders || folders.length === 0) {
      document.getElementById('no-folders').classList.remove('d-none');
      return;
    }

    folders.forEach((folder, index) => {
      // Create the tab element
      const tabItem = document.createElement('li');
      tabItem.className = 'nav-item';
      const tabLink = document.createElement('a');
      tabLink.className = index === 0
        ? 'nav-link py-1 px-2 bg-secondary text-white active'
        : 'nav-link py-1 px-2 bg-white text-secondary';
      tabLink.setAttribute('data-bs-toggle', 'tab');
      tabLink.setAttribute('href', `#folders-tab-${folder.uuid}`);
      tabLink.setAttribute('role', 'tab');
      tabLink.setAttribute('aria-controls', `folders-tab-${folder.uuid}`);
      tabLink.setAttribute('aria-selected', index === 0 ? 'true' : 'false');
      tabLink.id = `folders-tab-${folder.uuid}-tab`;
      tabLink.textContent = folder.name || 'Untitled Folder';
      tabItem.appendChild(tabLink);
      tabsContainer.appendChild(tabItem);

      // Create the content pane for this folder
      const contentPane = document.createElement('div');
      contentPane.className = `tab-pane fade ${index === 0 ? 'show active' : ''}`;
      contentPane.setAttribute('id', `folders-tab-${folder.uuid}`);
      contentPane.setAttribute('role', 'tabpanel');
      contentPane.setAttribute('aria-labelledby', `folders-tab-${folder.uuid}-tab`);

      // Build the dual list widget HTML with a filter input for available files
      const dualListHTML = buildDualListHTML(folder, files);

      contentPane.innerHTML = `
        <h4>${folder.name || 'Untitled Folder'}</h4>
        ${dualListHTML}
      `;
      contentContainer.appendChild(contentPane);
    });

    // Listen for tab activation events to update classes
    document.querySelectorAll('#foldersNavTabs a[data-bs-toggle="tab"]').forEach(tab => {
      tab.addEventListener('shown.bs.tab', function (event) {
        document.querySelectorAll('#foldersNavTabs a[data-bs-toggle="tab"]').forEach(t => {
          if (t === event.target) {
            t.classList.remove('bg-white', 'text-secondary');
            t.classList.add('bg-secondary', 'text-white');
          } else {
            t.classList.remove('bg-secondary', 'text-white');
            t.classList.add('bg-white', 'text-secondary');
          }
        });
      });
    });
  }

  // Helper: build the dual list widget for a folder with a filter input and scrollable divs.
  function buildDualListHTML(folder, files) {
    const selectedFileIds = new Set(folder.file_ids);
    let availableFilesForFolder = files.filter(file => !selectedFileIds.has(file.id));
    const selectedFilesForFolder = files.filter(file => selectedFileIds.has(file.id));

    return `
      <div class="row">
        <div class="col-md-6">
          <div class="card">
            <div class="card-header d-flex align-items-center justify-content-between">
              <h6 class="card-title mb-0 py-2">Available Files</h6>
              <button class="btn btn-secondary btn-sm">
                <i class="bi bi-plus-lg"></i>
                Upload
              </button>
            </div>
            <div class="card-header bg-white">
                <input type="text" class="form-control form-control-sm" placeholder="Filter available files" id="filter-available-${folder.uuid}" onkeyup="updateFolderContent('${folder.uuid}')">
            </div>
            <div class="card-body p-1" style="height: 300px; overflow-y: auto;">
              <ul class="list-group list-group-flush" id="available-files-${folder.uuid}">
                ${availableFilesForFolder.map(file => `
                  <li class="list-group-item d-flex justify-content-between align-items-center">
                    ${file.filename}
                    <button class="btn btn-sm btn-outline-secondary" onclick="addFileToFolder('${file.id}', '${folder.uuid}')">
                        <i class="bi bi-box-arrow-in-right"></i>
                    </button>
                  </li>
                `).join('')}
              </ul>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card border-success">
            <div class="card-header d-flex align-items-center justify-content-between bg-success-subtle">
              <h6 class="card-title mb-0 py-2">Selected Files</h6>
              <div class="spinner-border spinner-border-sm text-success d-none" id="updatingSpinner" role="status">
                <span class="visually-hidden">Updating...</span>
              </div>
            </div>
            <div class="card-header bg-white">
                <input type="text" class="form-control form-control-sm" placeholder="Filter selected files" id="filter-selected-${folder.uuid}" onkeyup="updateFolderContent('${folder.uuid}')">
            </div>
            <div class="card-body p-1" style="height: 300px; overflow-y: auto;">
              <ul class="list-group list-group-flush" id="selected-files-${folder.uuid}">
                ${selectedFilesForFolder.map(file => `
                  <li class="list-group-item d-flex justify-content-between align-items-center bg-opacity-10">
                    ${file.filename}
                    <button class="btn btn-sm btn-outline-secondary" onclick="removeFileFromFolder('${file.id}', '${folder.uuid}')">
                      <i class="bi bi-box-arrow-left"></i>
                    </button>
                  </li>
                `).join('')}
              </ul>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  // Call the backend to update the folder's file_ids.
  // The spinner is shown while the update is in progress.
  async function updateFolderBackend(folder) {
    const spinner = document.getElementById('updatingSpinner');
    spinner.classList.remove('d-none');
    try {
      // Construct the endpoint URL. Adjust as needed based on your backend routing.
      const urlTemplate = "{% url 'folders-api:update_folder' folder_uuid='FOLDER_UUID_PLACEHOLDER' %}";
      const url = urlTemplate.replace('FOLDER_UUID_PLACEHOLDER', folder.uuid);
      const response = await fetch(url, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${API_KEY}`,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ file_ids: folder.file_ids }),
      });
      if (!response.ok) {
        console.error("Error updating folder on backend:", response.statusText);
      }
    } catch (error) {
      console.error("Error updating folder on backend:", error);
    } finally {
      spinner.classList.add('d-none');
    }
  }

  // Add file to folder (update local state, re-render the UI, then call backend)
  async function addFileToFolder(fileId, folderUuid) {
    const folder = allFolders.find(f => f.uuid === folderUuid);
    if (!folder) return;
    if (!folder.file_ids.includes(fileId)) {
      folder.file_ids.push(fileId);
    }
    updateFolderContent(folderUuid);
    await updateFolderBackend(folder);
  }

  // Remove file from folder (update local state, re-render the UI, then call backend)
  async function removeFileFromFolder(fileId, folderUuid) {
    const folder = allFolders.find(f => f.uuid === folderUuid);
    if (!folder) return;
    folder.file_ids = folder.file_ids.filter(id => id !== fileId);
    updateFolderContent(folderUuid);
    await updateFolderBackend(folder);
  }

  // Update the dual list widget for a given folder and apply filtering to both available and selected files.
  function updateFolderContent(folderUuid) {
    const folder = allFolders.find(f => f.uuid === folderUuid);
    if (!folder) return;
    const selectedFileIds = new Set(folder.file_ids);
    let availableFilesForFolder = allFiles.filter(file => !selectedFileIds.has(file.id));
    let selectedFilesForFolder = allFiles.filter(file => selectedFileIds.has(file.id));

    // Apply filter for available files if provided
    const filterAvailableInput = document.getElementById(`filter-available-${folderUuid}`);
    if (filterAvailableInput && filterAvailableInput.value) {
      const filterValue = filterAvailableInput.value.toLowerCase();
      availableFilesForFolder = availableFilesForFolder.filter(file => file.filename.toLowerCase().includes(filterValue));
    }

    // Apply filter for selected files if provided
    const filterSelectedInput = document.getElementById(`filter-selected-${folderUuid}`);
    if (filterSelectedInput && filterSelectedInput.value) {
      const filterValue = filterSelectedInput.value.toLowerCase();
      selectedFilesForFolder = selectedFilesForFolder.filter(file => file.filename.toLowerCase().includes(filterValue));
    }

    const availableList = document.getElementById(`available-files-${folderUuid}`);
    const selectedList = document.getElementById(`selected-files-${folderUuid}`);

    if (availableList && selectedList) {
      availableList.innerHTML = availableFilesForFolder.map(file => `
        <li class="list-group-item d-flex justify-content-between align-items-center">
          ${file.filename}
          <button class="btn btn-sm btn-outline-secondary" onclick="addFileToFolder('${file.id}', '${folderUuid}')">
              <i class="bi bi-box-arrow-in-right"></i>
          </button>
        </li>
      `).join('');

      selectedList.innerHTML = selectedFilesForFolder.map(file => `
        <li class="list-group-item d-flex justify-content-between align-items-center">
          ${file.filename}
          <button class="btn btn-sm btn-outline-secondary" onclick="removeFileFromFolder('${file.id}', '${folderUuid}')">
            <i class="bi bi-box-arrow-left"></i>
          </button>
        </li>
      `).join('');
    }
  }

  // Call fetchFoldersTab on page load (or on an event)
  document.addEventListener('DOMContentLoaded', fetchFoldersTab);
</script>
