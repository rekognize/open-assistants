<script>
document.addEventListener('DOMContentLoaded', function () {
    const shareThreadButton = document.getElementById('share-thread-button');

    shareThreadButton.addEventListener('click', function() {
        const url = `/t/share/${threadId}/`;

        fetch(url, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
        })
        .then(response => response.json())
        .then(data => {
            const linksList = document.getElementById('shared-links-list');
            linksList.innerHTML = ''; // Clear existing links

            if (data.links) {
                data.links.forEach(link => {
                    const linkElement = document.createElement('div');
                    linkElement.className = 'd-flex justify-content-between align-items-center';
                    linkElement.innerHTML = `
                        <input class="form-control me-2" type="text" value="${link.url}" readonly>
                        <button class="btn btn-outline-secondary btn-sm copy-link-btn me-1" data-url="${link.url}">
                            <i class="bi bi-clipboard"></i>
                        </button>
                        <button class="btn btn-outline-danger btn-sm delete-link-btn" data-token="${link.token}">
                            <i class="bi bi-trash"></i>
                        </button>
                    `;
                    linksList.appendChild(linkElement);
                });
            }

            // Setup event listeners for new buttons
            setupLinkButtons();

        });
    });
});

document.getElementById('create-shared-link').addEventListener('click', function() {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    fetch(`/t/share/${threadId}/`, {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': csrfToken,
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // Update the UI with the new link
            const linksList = document.getElementById('shared-links-list');
            const linkElement = document.createElement('div');
            linkElement.className = 'd-flex justify-content-between align-items-center';
            linkElement.innerHTML = `
                <input class="form-control me-2" type="text" value="${data.link.url}" readonly>
                <button class="btn btn-outline-secondary btn-sm copy-link-btn me-1" data-url="${data.link.url}">
                    <i class="bi bi-clipboard"></i>
                </button>
                <button class="btn btn-outline-danger btn-sm delete-link-btn" data-token="${data.link.token}">
                    <i class="bi bi-trash"></i>
                </button>
            `;
            linksList.appendChild(linkElement);

            showToast('Success', data.message, data.status);
        } else if (data.status === 'info') {
            showToast('Info', data.message, 'info');
        } else {
            showToast('Error', 'Failed to create a link!');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error', 'An unexpected error occurred.', 'danger');
    });
});

let isSetup = false;

function setupLinkButtons() {
    if (isSetup) return;  // Prevent re-initialization
    isSetup = true;

    document.getElementById('shared-links-list').addEventListener('click', function(event) {
        if (event.target.closest('.copy-link-btn')) {
            const url = event.target.closest('.copy-link-btn').getAttribute('data-url');
            navigator.clipboard.writeText(url).then(() => {
                showToast('Success', 'Link copied to clipboard.', 'success');
            }).catch(err => console.error('Error copying link: ', err));
        }

        if (event.target.closest('.delete-link-btn')) {
            const token = event.target.closest('.delete-link-btn').getAttribute('data-token');
            const deleteSharedLinkConfirmationModal = new bootstrap.Modal(document.getElementById('deleteSharedLinkConfirmationModal'));
            deleteSharedLinkConfirmationModal.show();

            document.getElementById('confirm-delete-shared-link').onclick = function() {
                deleteSharedLink(token);
            };
        }
    });
}


function deleteSharedLink(token) {
    fetch(`/t/share/delete/${token}/`, {
        method: 'POST',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            // Refresh the list of links or remove the deleted link from the DOM
            document.querySelector(`.delete-link-btn[data-token="${token}"]`).parentNode.remove();

            // Hide the modal
            const deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteSharedLinkConfirmationModal'));
            deleteModal.hide();

            showToast('Success', data.message, 'success');
        } else if (data.status === 'info') {
            showToast('Info', data.message, 'info');
        } else {
            showToast('Error', 'An error occurred while deleting the link!');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Error', 'An unexpected error occurred.', 'danger');
    });
}
</script>
