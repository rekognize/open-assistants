<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentStep = 1;
    const totalSteps = 3;

    const backButton = document.getElementById('getStartedBackButton');
    const nextButton = document.getElementById('getStartedNextButton');
    const resetButton = document.getElementById('getStartedResetButton');
    const progressBar = document.getElementById('getStartedProgressBar');
    const spinner = nextButton.querySelector('.spinner-border');
    const buttonText = nextButton.querySelector('.button-text');

    let assistantData = {};
    let vectorStoreData = {};
    let fileData = {};

    const maxNameLength = 256;
    const maxDescriptionLength = 512;

    const assistantNameInput = document.getElementById('assistantName');
    const assistantDescriptionInput = document.getElementById('assistantDescription');
    const assistantInstructionsInput = document.getElementById('assistantInstructions');
    const assistantModelSelect = document.getElementById('assistantModel');
    const nameHelp = document.getElementById('nameHelp');
    const descriptionHelp = document.getElementById('descriptionHelp');

    const uploadFileCheckbox = document.getElementById('uploadFileCheckbox');
    const fileUploadForm = document.getElementById('fileUploadForm');
    const fileUploadInput = document.getElementById('fileUploadInput');
    const existingVectorStoreSelect = document.getElementById('existingVectorStoreSelect');

    // Show/hide name help text
    assistantNameInput.addEventListener('input', function() {
        const currentLength = assistantNameInput.value.length;
        nameHelp.classList.toggle('d-none', currentLength < maxNameLength);
    });

    // Show/hide description help text
    assistantDescriptionInput.addEventListener('input', function() {
        const currentLength = assistantDescriptionInput.value.length;
        descriptionHelp.classList.toggle('d-none', currentLength < maxDescriptionLength);
    });

    function showStep(step) {
        for (let i = 1; i <= totalSteps; i++) {
            const stepDiv = document.getElementById('getStartedStep' + i);
            stepDiv.classList.toggle('d-none', i !== step);
        }

        const progressPercent = (step / totalSteps) * 100;
        progressBar.style.width = progressPercent + '%';
        progressBar.setAttribute('aria-valuenow', progressPercent);
        progressBar.innerText = 'Step ' + step + ' of ' + totalSteps;

        backButton.disabled = (step === 1);

        if (step === totalSteps) {
            nextButton.classList.remove('btn-primary');
            nextButton.classList.add('btn-success');
            buttonText.textContent = 'Finish';
            populateSummary();
        } else {
            nextButton.classList.remove('btn-success');
            nextButton.classList.add('btn-primary');
            buttonText.textContent = 'Next';
        }
    }

    backButton.addEventListener('click', function() {
        if (currentStep > 1) {
            currentStep--;
            showStep(currentStep);
        }
    });

    nextButton.addEventListener('click', async function() {
        const isValid = validateStep(currentStep);
        if (isValid) {
            if (currentStep < totalSteps) {
                currentStep++;
                showStep(currentStep);
            } else {
                // On finish, show loading spinner and start creation process
                spinner.classList.remove('d-none');
                buttonText.textContent = 'Creating...';
                nextButton.disabled = true;
                backButton.disabled = true;
                resetButton.disabled = true;

                try {
                    const vectorStoreOption = document.querySelector('input[name="vectorStoreOption"]:checked').value;

                    let createdVectorStoreId = null;

                    // 1. Create Vector Store if needed
                    if (vectorStoreOption === 'create') {
                        createdVectorStoreId = await createVectorStoreApi(vectorStoreData.name);
                        if (!createdVectorStoreId) {
                            throw new Error('Failed to create vector store.');
                        }
                        // 2. If files selected, upload them
                        if (fileData.files && fileData.files.length > 0) {
                            const fileUploadSuccess = await uploadFilesApi(createdVectorStoreId, fileData.files);
                            if (!fileUploadSuccess) {
                                throw new Error('File upload failed.');
                            }
                        }
                    }

                    // Determine which vector store ID to associate with the assistant tools
                    let associatedVectorStoreId = null;
                    if (vectorStoreOption === 'select') {
                        associatedVectorStoreId = existingVectorStoreSelect.value || null;
                    } else if (vectorStoreOption === 'create') {
                        associatedVectorStoreId = createdVectorStoreId;
                    }

                    // 3. Create the Assistant
                    const assistantCreated = await createAssistantApi(assistantData, associatedVectorStoreId);
                    if (!assistantCreated) {
                        throw new Error('Failed to create assistant.');
                    }

                    // On success, redirect to manage page
                    showToast('Setup Completed', 'Your assistant has been set up.', 'success');
                    setTimeout(() => {
                        window.location.href = '{% url "manage_assistants" %}';
                    }, 1000);

                } catch (error) {
                    showToast('Creation Error', error.message, 'warning');
                    console.error(error);
                } finally {
                    spinner.classList.add('d-none');
                    buttonText.textContent = 'Finish';
                    nextButton.disabled = false;
                    backButton.disabled = false;
                    resetButton.disabled = false;
                }
            }
        }
    });

    resetButton.addEventListener('click', function() {
        resetModal();
    });

    function resetModal() {
        currentStep = 1;
        showStep(currentStep);

        assistantData = {};
        vectorStoreData = {};
        fileData = {};

        // Reset form fields
        document.getElementById('assistantForm').reset();
        nameHelp.classList.add('d-none');
        descriptionHelp.classList.add('d-none');

        // Reset vector store options
        document.getElementById('noVectorStoreOption').checked = true;
        toggleVectorStoreOptions();

        // Clear vector store selection
        existingVectorStoreSelect.selectedIndex = 0;

        // Uncheck file upload checkbox and clear files
        uploadFileCheckbox.checked = false;
        fileUploadForm.classList.add('d-none');
        fileUploadInput.value = '';

        // Hide spinner if visible
        spinner.classList.add('d-none');
        buttonText.textContent = 'Next';

        loadExistingVectorStores();
    }

    function validateStep(step) {
        let isValid = true;
        if (step === 1) {
            const assistantName = assistantNameInput.value.trim();
            const assistantDescription = assistantDescriptionInput.value.trim();
            const assistantInstructions = assistantInstructionsInput.value.trim();
            const assistantModel = assistantModelSelect.value;

            if (!assistantName || !assistantInstructions || !assistantModel) {
                isValid = false;
                showToast('Validation Error', 'Please fill in all required fields.', 'warning');
            }

            if (isValid) {
                assistantData = {
                    name: assistantName,
                    description: assistantDescription,
                    instructions: assistantInstructions,
                    model: assistantModel
                };
            }
        } else if (step === 2) {
            const vectorStoreOption = document.querySelector('input[name="vectorStoreOption"]:checked').value;
            vectorStoreData = {};
            fileData = {};

            if (vectorStoreOption === 'select') {
                const selectedId = existingVectorStoreSelect.value;
                if (!selectedId) {
                    isValid = false;
                    showToast('Validation Error', 'Please select a vector store.', 'warning');
                } else {
                    vectorStoreData.id = selectedId;
                }
            } else if (vectorStoreOption === 'create') {
                const vectorStoreName = document.getElementById('vectorStoreName').value.trim();
                if (!vectorStoreName) {
                    isValid = false;
                    showToast('Validation Error', 'Please enter a name for the vector store.', 'warning');
                }

                if (uploadFileCheckbox.checked) {
                    if (fileUploadInput.files.length === 0) {
                        isValid = false;
                        showToast('Validation Error', 'Please select at least one file to upload.', 'warning');
                    } else {
                        fileData.files = fileUploadInput.files;
                    }
                }

                if (isValid) {
                    vectorStoreData.name = vectorStoreName;
                }
            }
        }
        return isValid;
    }

    function populateSummary() {
        const summaryContent = document.getElementById('summaryContent');
        let html = '<h6>Assistant Details</h6>';
        html += `<p><strong>Name:</strong> ${assistantData.name}</p>`;
        html += `<p><strong>Description:</strong> ${assistantData.description || 'N/A'}</p>`;
        html += `<p><strong>Instructions:</strong> ${assistantData.instructions}</p>`;
        html += `<p><strong>Model:</strong> ${assistantData.model}</p>`;

        if (vectorStoreData.id) {
            html += '<h6>Selected Vector Store</h6>';
            const vsName = vectorStores[vectorStoreData.id]?.name ?? 'Untitled Store';
            html += `<p><strong>Name:</strong> ${vsName}</p>`;
        } else if (vectorStoreData.name) {
            html += '<h6>Vector Store to be Created</h6>';
            html += `<p><strong>Name:</strong> ${vectorStoreData.name}</p>`;

            if (fileData.files && fileData.files.length > 0) {
                html += '<h6>Files to Upload</h6><ul>';
                for (let i = 0; i < fileData.files.length; i++) {
                    html += `<li>${fileData.files[i].name}</li>`;
                }
                html += '</ul>';
            } else {
                html += '<p>No files will be uploaded.</p>';
            }
        } else {
            html += '<p>No vector store will be associated.</p>';
        }

        summaryContent.innerHTML = html;
    }

    const vectorStoreOptions = document.querySelectorAll('input[name="vectorStoreOption"]');
    vectorStoreOptions.forEach(option => {
        option.addEventListener('change', toggleVectorStoreOptions);
    });

    function toggleVectorStoreOptions() {
        const selectedOption = document.querySelector('input[name="vectorStoreOption"]:checked').value;
        const selectSection = document.getElementById('selectVectorStoreSection');
        const createSection = document.getElementById('createVectorStoreSection');

        if (selectedOption === 'none') {
            selectSection.classList.add('d-none');
            createSection.classList.add('d-none');
            document.getElementById('vectorStoreName').value = '';
            uploadFileCheckbox.checked = false;
            fileUploadForm.classList.add('d-none');
            fileUploadInput.value = '';
        } else if (selectedOption === 'select') {
            selectSection.classList.remove('d-none');
            createSection.classList.add('d-none');
            document.getElementById('vectorStoreName').value = '';
            uploadFileCheckbox.checked = false;
            fileUploadForm.classList.add('d-none');
            fileUploadInput.value = '';
            loadExistingVectorStores();
        } else if (selectedOption === 'create') {
            selectSection.classList.add('d-none');
            createSection.classList.remove('d-none');
        }
    }

    uploadFileCheckbox.addEventListener('change', function() {
        if (uploadFileCheckbox.checked) {
            fileUploadForm.classList.remove('d-none');
        } else {
            fileUploadForm.classList.add('d-none');
            fileUploadInput.value = '';
        }
    });

    function loadExistingVectorStores() {
        const existingSelect = document.getElementById('existingVectorStoreSelect');
        // Clear old options
        for (let i = existingSelect.options.length - 1; i >= 1; i--) {
            existingSelect.remove(i);
        }

        const vectorStoreEntries = Object.entries(vectorStores);
        if (vectorStoreEntries.length === 0) {
            document.getElementById('selectVectorStoreOption').classList.add('d-none');
            document.querySelector('label[for="selectVectorStoreOption"]').classList.add('d-none');
            document.getElementById('selectVectorStoreSection').classList.add('d-none');
            if (document.getElementById('selectVectorStoreOption').checked) {
                document.getElementById('noVectorStoreOption').checked = true;
                toggleVectorStoreOptions();
            }
            return;
        } else {
            document.getElementById('selectVectorStoreOption').classList.remove('d-none');
            document.querySelector('label[for="selectVectorStoreOption"]').classList.remove('d-none');
        }

        vectorStoreEntries.forEach(([vsId, vs]) => {
            const option = document.createElement('option');
            option.value = vsId;
            option.textContent = vs.name ?? 'Untitled Store';
            existingSelect.appendChild(option);
        });
    }

    // ========== API Helper Functions ==========

    async function createVectorStoreApi(name) {
        try {
            const payload = {
                name: name
            };
            const response = await fetch("{% url 'api-1.0.0:create_vector_store' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(payload)
            });
            if (response.ok) {
                const data = await response.json();
                return data.id;
            } else {
                const errorData = await response.json();
                console.error('Create vector store error:', errorData);
            }
        } catch (error) {
            console.error('Create vector store error:', error);
        }
        return null;
    }

    async function uploadFilesApi(vectorStoreId, files) {
        try {
            const formData = new FormData();
            for (let i = 0; i < files.length; i++) {
                formData.append('files', files[i]);
            }
            formData.append('vector_store_ids', JSON.stringify([vectorStoreId]));

            const response = await fetch("{% url 'api-1.0.0:upload_files' %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: formData
            });
            if (response.ok) {
                return true;
            } else {
                const errorData = await response.json();
                console.error('File upload error:', errorData);
            }
        } catch (error) {
            console.error('File upload error:', error);
        }
        return false;
    }

    async function createAssistantApi(assistantData, vectorStoreId) {
        try {
            // If a vector store is associated, add file_search tool and tool_resources
            let tools = [];
            let tool_resources = {};

            if (vectorStoreId) {
                tools.push({ "type": "file_search" });
                tool_resources["file_search"] = {
                    "vector_store_ids": [vectorStoreId]
                };
            }

            const payload = {
                name: assistantData.name,
                description: assistantData.description || '',
                instructions: assistantData.instructions,
                model: assistantData.model,
                tools: tools,
                tool_resources: tool_resources,
                metadata: {}
            };

            const response = await fetch("{% url 'api-1.0.0:create_assistant' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(payload)
            });

            if (response.ok) {
                return true;
            } else {
                const errorData = await response.json();
                console.error('Create assistant error:', errorData);
            }
        } catch (error) {
            console.error('Create assistant error:', error);
        }
        return false;
    }

    // Initialize
    showStep(currentStep);
});
</script>
