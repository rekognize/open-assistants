{% extends "base.html" %}


{% block title %}Analytics{% endblock %}

{% block extra_head %}

<style>
    .custom-popover {
      --bs-popover-max-width: 400px;
    }
</style>

{% endblock %}

{% block content %}

    <div class="container mt-4 mb-4">

        <!-- Assistants Table -->
        <div id="assistants-container" class="my-4">

            <h5 class="my-3">Assistant usage overview</h5>

            {% include 'partials/loading_indicator.html' with content_id='assistants' content_name='assistants' %}

            <div class="row">

                <div class="col-3">
                    <ul class="nav nav-pills flex-column" role="tablist" id="assistantTabs">
                    </ul>
                </div>

                <div class="col-9">
                    <div class="tab-content" id="assistantContent">
                    </div>
                </div>

            </div>

            <div id="no-assistants" class="text-center text-secondary d-none">
                <p>No assistants available.</p>
                <span class="text-secondary">
                    You can create assistants <a href="{% url "manage_assistants" project_uuid=selected_project.uuid %}" class="text-decoration-none">here</a>.
                </span>
            </div>

        </div>

    </div>

{% endblock %}

{% block extra_scripts %}
<script>

    const API_KEY = "{{ selected_project.uuid }}";

    /* Utility functions */

    function initializePopovers() {
        const popoverTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
        popoverTriggerList.map(function (popoverTriggerEl) {
            return new bootstrap.Popover(popoverTriggerEl);
        });
    }

    function formatDbDate(dateString) {
        if (!dateString) return '<span class="text-secondary">No threads</span>';
        const date = new Date(dateString);
        // Extract day, month, year, hours, and minutes
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');

        return `${day}/${month}/${year}, ${hours}:${minutes}`;
    }

    function formatUnixTimestamp(unixTimestamp) {
        const date = new Date(unixTimestamp * 1000); // Convert seconds to milliseconds
        const day = String(date.getDate()).padStart(2, '0'); // Ensure 2 digits for the day
        const month = String(date.getMonth() + 1).padStart(2, '0'); // Months are 0-indexed
        const year = date.getFullYear();
        const hours = String(date.getHours()).padStart(2, '0'); // 24-hour format
        const minutes = String(date.getMinutes()).padStart(2, '0');

        return `${day}/${month}/${year}, ${hours}:${minutes}`;
    }

    function formatExpireTime(expireString) {
        let icon = '';

        if (expireString === 'Expired') {
            icon = '<i class="bi bi-exclamation-circle text-danger"></i> ';
        } else {
            const parts = expireString.split(' ');
            if (parts.length === 2) {
                const unit = parts[1]; // yrs, mos, days, hrs, mins, secs

                const soonUnits = ['hrs', 'mins', 'secs'];
                if (soonUnits.includes(unit)) {
                    icon = ' <i class="bi bi-exclamation-triangle text-warning"></i> ';
                }
            }
        }

        return icon + expireString;
    }


    /* Assistants */

async function fetchAssistants() {
    try {
        const assistantsResponse = await fetch("{% url 'api-1.0.0:list_assistants' %}", {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${API_KEY}`,
                'Content-Type': 'application/json',
            }
        });

        const assistantsData = await assistantsResponse.json();

        console.log('assistants:', assistantsData);

        populateTabsAndContent(assistantsData.assistants);

    } catch (error) {
        console.error('Error fetching assistants:', error);
    } finally {
        toggleLoading('assistants', false);
    }
}

function populateTabsAndContent(assistants) {
    const tabsContainer = document.getElementById('assistantTabs');
    const contentContainer = document.getElementById('assistantContent');

    tabsContainer.innerHTML = '';
    contentContainer.innerHTML = '';

    assistants.forEach((assistant, index) => {
        const tabItem = document.createElement('li');
        tabItem.className = 'nav-item';

        const tabLink = document.createElement('a');
        tabLink.className = `nav-link ${index === 0 ? 'active' : ''}`;
        tabLink.setAttribute('data-bs-toggle', 'tab');
        tabLink.setAttribute('href', `#assistant-${assistant.id}`);
        tabLink.setAttribute('role', 'tab');
        tabLink.setAttribute('aria-controls', `assistant-${assistant.id}`);
        tabLink.setAttribute('aria-selected', index === 0 ? 'true' : 'false');
        tabLink.textContent = assistant.name || 'Unnamed Assistant';

        tabItem.appendChild(tabLink);
        tabsContainer.appendChild(tabItem);

        const contentPane = document.createElement('div');
        contentPane.className = `tab-pane fade ${index === 0 ? 'show active' : ''}`;
        contentPane.setAttribute('id', `assistant-${assistant.id}`);
        contentPane.setAttribute('role', 'tabpanel');
        contentPane.setAttribute('aria-labelledby', `assistant-${assistant.id}-tab`);

        contentPane.innerHTML = `
            <h4>${assistant.name || 'Unnamed Assistant'}</h4>
            <p><strong>Model:</strong> ${assistant.model}</p>
            <p><strong>Tools:</strong> ${assistant.tools.map(tool => tool.type).join(', ') || 'None'}</p>
            <p><em>Fetching threads...</em></p>
            <div id="stats-${assistant.id}"></div>
        `;

        contentContainer.appendChild(contentPane);

        fetchTokenUsageStats(assistant.id);
    });
}

async function fetchTokenUsageStats(assistantId) {
    const listThreadsUrlTemplate = "{% url 'api-1.0.0:list_threads' assistant_id='ASSISTANT_ID_PLACEHOLDER' %}";
    const url = listThreadsUrlTemplate.replace('ASSISTANT_ID_PLACEHOLDER', assistantId);

    try {
        const threadsResponse = await fetch(url, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${API_KEY}`,
                'Content-Type': 'application/json',
            }
        });
        const threadsData = await threadsResponse.json();

        const threads = threadsData['threads'];
        if (threads.length === 0) {
            document.getElementById(`stats-${assistantId}`).innerHTML = `<strong>No threads yet.</strong>`;
            return;
        }

        let sharedThreads = 0;
        let testThreads = 0;
        const threadSections = {};

        threads.forEach(thread => {
            const shareName = thread.share || 'Test Threads';
            threadSections[shareName] = threadSections[shareName] || [];
            threadSections[shareName].push(thread);

            if (thread.share) {
                sharedThreads++;
            } else {
                testThreads++;
            }
        });

        const firstDate = new Date(threads[0].created_at).toLocaleString();
        const lastDate = new Date(threads[threads.length - 1].created_at).toLocaleString();

        const summary = `<p>${sharedThreads} shared and ${testThreads} test threads run between ${firstDate} & ${lastDate}</p>`;

        const accordionId = `accordion-${assistantId}`;
        let accordionHtml = `<div class="accordion" id="${accordionId}">`;

        Object.keys(threadSections).forEach((shareName, index) => {
            const threads = threadSections[shareName];
            const sectionId = `collapse-${assistantId}-${index}`;
            const progressId = `progress-${assistantId}-${index}`;
            const tableId = `table-${assistantId}-${index}`;

            accordionHtml += `
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#${sectionId}" aria-expanded="false" aria-controls="${sectionId}" disabled>
                            <div class="d-flex w-100 justify-content-between align-items-center">
                                <span>${shareName} (${threads.length} threads)</span>
                                <div class="progress w-50 me-3">
                                    <div id="${progressId}" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </div>
                        </button>
                    </h2>
                    <div id="${sectionId}" class="accordion-collapse collapse" aria-labelledby="heading-${index}" data-bs-parent="#${accordionId}">
                        <div class="accordion-body">
                            <table id="${tableId}" class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Thread ID</th>
                                        <th>Date</th>
                                        <th>Tokens Used</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>`;

            fetchThreadRuns(threads, progressId, tableId, sectionId);
        });

        accordionHtml += `</div>`;

        document.getElementById(`stats-${assistantId}`).innerHTML = summary + accordionHtml;

    } catch (error) {
        console.error(`Error fetching token usage stats for assistant ${assistantId}:`, error);
        document.getElementById(`stats-${assistantId}`).innerHTML = `<strong>Error loading stats.</strong>`;
    }
}

async function fetchThreadRuns(threads, progressId, tableId, sectionId) {
    let completedThreads = 0;
    const totalThreads = threads.length;

    for (const thread of threads) {
        const listRunsUrlTemplate = "{% url 'api-1.0.0:list_runs' thread_id='THREAD_ID_PLACEHOLDER' %}";
        const url = listRunsUrlTemplate.replace('THREAD_ID_PLACEHOLDER', thread.id);

        try {
            const runsResponse = await fetch(url, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${API_KEY}`,
                    'Content-Type': 'application/json',
                }
            });
            const runsData = await runsResponse.json();

            const tokensTotal = runsData.runs.reduce((sum, run) => sum + run.usage.total_tokens, 0);
            const tokensPrompt = runsData.runs.reduce((sum, run) => sum + run.usage.prompt_tokens, 0);
            const tokensCompletion = runsData.runs.reduce((sum, run) => sum + run.usage.completion_tokens, 0);
            const threadRow = `<tr>
                <td>${thread.id}</td>
                <td>${new Date(thread.created_at).toLocaleString()}</td>
                <td>${tokensPrompt} prompt, ${tokensCompletion} completion, ${tokensTotal} total</td>
            </tr>`;

            document.querySelector(`#${tableId} tbody`).innerHTML += threadRow;
        } catch (error) {
            console.error(`Error fetching runs for thread ${thread.id}:`, error);
        } finally {
            completedThreads++;
            const progress = (completedThreads / totalThreads) * 100;
            const progressBar = document.getElementById(progressId);
            progressBar.style.width = `${progress}%`;
            progressBar.setAttribute('aria-valuenow', progress);

            if (progress === 100) {
                document.querySelector(`[data-bs-target="#${sectionId}"]`).removeAttribute('disabled');
            }
        }
    }
}

/* Initialize Page */

async function initializePage() {
    toggleLoading('assistants', true);
    fetchAssistants();
}

initializePage();

</script>

{% include "partials/utils_js.html" %}

{% endblock %}
