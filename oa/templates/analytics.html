{% extends "base.html" %}


{% block title %}Analytics - Open Assistants{% endblock %}

{% block content %}

    <div class="container mt-4 mb-4">

        <!-- Assistants Table -->
        <div id="assistants-container" class="my-4 d-none">
            <h5>Assistants</h5>
            <table class="table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Tools</th>
                        <th>Vector Store</th>
                        <th>Threads</th>
                        <th>First used</th>
                        <th>Last used</th>
                    </tr>
                </thead>
                <tbody id="assistants-table-body"></tbody>
            </table>
        </div>

        <!-- Vector Stores Table -->
        <div id="vector-stores-container" class="my-4 d-none">
            <h5>Vector Stores</h5>
            <table class="table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Status</th>
                        <th>Files</th>
                    </tr>
                </thead>
                <tbody id="vector-stores-table-body"></tbody>
            </table>
        </div>

    </div>

{% endblock %}

{% block extra_scripts %}
<script>
    /* Assistants Table */

    async function fetchThreadsData() {
        try {
            const response = await fetch("{% url 'get_assistant_threads' %}");
            return await response.json();
        } catch (error) {
            console.error('Error fetching thread counts:', error);
            return {};
        }
    }

    async function fetchAssistantsTable() {
        try {
            // Fetch assistants and threads data in parallel
            const [assistantsResponse, threadsData] = await Promise.all([
                fetch("{% url 'api-1.0.0:list_assistants' %}").then(res => res.json()),
                fetchThreadsData()
            ]);

            const assistantsData = assistantsResponse;
            console.log(assistantsData);
            console.log(threadsData);

            if (assistantsData.assistants?.length > 0) {
                const tableBody = document.getElementById('assistants-table-body');
                tableBody.innerHTML = '';

                assistantsData.assistants.forEach(assistant => {
                    const threadInfo = threadsData[assistant.id] || {thread_count:0, first_thread:null, last_thread:null};
                    const { thread_count, first_thread, last_thread } = threadInfo;

                    const firstUsed = first_thread ? new Date(first_thread).toLocaleString() : '<span class="text-secondary">No threads</span>';
                    const lastUsed = last_thread ? new Date(last_thread).toLocaleString() : '<span class="text-secondary">No threads</span>';

                    tableBody.innerHTML += `
                        <tr>
                            <td>${assistant.name || 'Untitled assistant'}</td>
                            <td>${assistant.tools.map(tool => tool.type).join(', ') || '<span class="text-secondary">No tools</span>'}</td>
                            <td>${assistant.tool_resources?.file_search?.vector_store_ids?.[0] || '<span class="text-secondary">No vector store</span>'}</td>
                            <td>${thread_count || 0}</td>
                            <td>${firstUsed}</td>
                            <td>${lastUsed}</td>
                        </tr>`;
                });

                // Show the Assistants table
                document.getElementById('assistants-container').classList.remove('d-none');
            }
        } catch (error) {
            console.error('Error fetching assistants:', error);
        }
    }


    /* Vector Stores Table */

    async function fetchVectorStoreFilesCount(vectorStoreId) {
        try {
            const listVSFilesUrlTemplate = "{% url 'api-1.0.0:list_vector_store_files' vector_store_id='VS_ID_PLACEHOLDER' %}";
            const url = listVSFilesUrlTemplate.replace('VS_ID_PLACEHOLDER', vectorStoreId);
            const response = await fetch(url);
            const data = await response.json();
            return data.files?.length || 0;
        } catch (error) {
            console.error(`Error fetching files for vector store ${vectorStoreId}:`, error);
            return 0;
        }
    }

    async function fetchVectorStoresTable() {
        try {
            const response = await fetch("{% url 'api-1.0.0:list_vector_stores' %}");
            const data = await response.json();

            if (data.vector_stores?.length > 0) {
                const tableBody = document.getElementById('vector-stores-table-body');
                tableBody.innerHTML = '';

                const fileCountPromises = data.vector_stores.map(async store => {
                    const fileCount = await fetchVectorStoreFilesCount(store.id);
                    return { ...store, fileCount };
                });

                console.log(fileCountPromises);

                const storesWithCounts = await Promise.all(fileCountPromises);
                storesWithCounts.forEach(store => {
                    tableBody.innerHTML += `
                        <tr>
                            <td>${store.name || 'Untitled store'}</td>
                            <td>${store.status}</td>
                            <td>${store.fileCount}</td>
                        </tr>`;
                });

                // Show the Vector Stores table
                document.getElementById('vector-stores-container').classList.remove('d-none');
            }
        } catch (error) {
            console.error('Error fetching vector stores:', error);
        }
    }

    // Initialize fetching
    fetchAssistantsTable();
    fetchVectorStoresTable();
</script>
{% endblock %}
