{% extends "base.html" %}


{% block title %}Analytics - Open Assistants{% endblock %}

{% block content %}

    <div class="container mt-4 mb-4">
        <div id="assistants-container" class="my-4 d-none">
            <h5>Assistants</h5>
            <table class="table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Tools</th>
                        <th>Vector Store</th>
                        <th>Threads</th>
                    </tr>
                </thead>
                <tbody id="assistants-table-body"></tbody>
            </table>
        </div>

        <!-- Vector Stores Table -->
        <div id="vector-stores-container" class="my-4 d-none">
            <h5>Vector Stores</h5>
            <table class="table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="vector-stores-table-body"></tbody>
            </table>
        </div>
    </div>

{% endblock %}

{% block extra_scripts %}
<script>
    async function fetchThreadsData() {
        try {
            const response = await fetch("{% url 'get_assistant_threads' %}");
            const data = await response.json();
            console.log(data);

            return data;
        } catch (error) {
            console.error("Error fetching thread counts:", error);
            return {};
        }
    }

    async function fetchAssistantsTable() {
        try {
            const response = await fetch("{% url 'api-1.0.0:list_assistants' %}");
            const assistantsData = await response.json();

            // Fetch thread counts
            const threadCounts = await fetchThreadsData();

            if (assistantsData.assistants && assistantsData.assistants.length > 0) {
                const tableBody = document.getElementById('assistants-table-body');
                tableBody.innerHTML = '';

                assistantsData.assistants.forEach(assistant => {
                    const threadCount = threadCounts[assistant.id] || 0;

                    const row = `<tr>
                        <td>${assistant.name || 'Untitled assistant'}</td>
                        <td>${assistant.tools.map(tool => tool.type).join(', ') || '<span class="text-secondary">No tools</span>'}</td>
                        <td>${assistant.tool_resources?.file_search?.vector_store_ids?.[0] || '<span class="text-secondary">No vector store</span>'}</td>
                        <td>${threadCount}</td>
                    </tr>`;
                    tableBody.innerHTML += row;
                });

                // Show the Assistants table
                document.getElementById('assistants-container').classList.remove('d-none');
            } else {
                const parsedError = parseErrorText(assistantsData.error);
                showToast("Failed to fetch assistants!", parsedError.errorMessage);
                console.error('Failed to fetch assistants!', parsedError);
                return {};
            }
        } catch (error) {
            console.error('Error fetching assistants:', error);
        }
    }

    async function fetchVectorStoresTable() {
        try {
            const response = await fetch("{% url 'api-1.0.0:list_vector_stores' %}");
            const data = await response.json();

            if (data.vector_stores && data.vector_stores.length > 0) {
                const tableBody = document.getElementById('vector-stores-table-body');
                tableBody.innerHTML = '';

                data.vector_stores.forEach(store => {
                    const row = `<tr>
                        <td>${store.name || 'Untitled store'}</td>
                        <td>${store.status}</td>
                    </tr>`;
                    tableBody.innerHTML += row;
                });

                // Show the Vector Stores table
                document.getElementById('vector-stores-container').classList.remove('d-none');
            }
        } catch (error) {
            console.error('Error fetching vector stores:', error);
        }
    }

    // Initialize fetching
    fetchAssistantsTable();
    fetchVectorStoresTable();
</script>
{% endblock %}
