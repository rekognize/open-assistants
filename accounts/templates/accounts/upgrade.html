{% extends 'base.html' %}

{% load static %}


{% block content %}

<div class="container my-5">
    <h1 class="text-center display-6 lead m-5">
        <small>Upgrade to Pro Plan</small>
    </h1>
    <div class="row justify-content-center mt-4">
        <div class="col-md-5">
            <div class="card h-100 d-flex flex-column">
                <div class="card-header text-center">
                    <h5 class="text-secondary m-2">Free Plan</h5>
                </div>
                <div class="card-body d-flex flex-column">
                    <ul>
                        <li>Use your own OpenAI API project key
                            <br>
                            <small>
                                Add your
                                <a href="#" data-bs-toggle="modal" data-bs-target="#manageKeysModal">existing project key</a>
                                or get a new one from
                                <a href="https://platform.openai.com/api-keys" target="_blank">OpenAI</a>.
                                You will be charged separately by OpenAI for your usage.
                            </small>
                        </li>
                        <li>Access basic management features to create, test, and publish your AI assistants</li>
                    </ul>
                </div>
                <div class="card-footer text-center">
                    <a href="/" class="btn btn-outline-secondary">Continue with the Free Plan</a>
                </div>
            </div>
        </div>

        <div class="col-md-5">
            <div class="card border-success h-100 d-flex flex-column">
                <div class="card-header text-white text-center bg-success">
                    <h5 class="text-white m-2">Pro Plan - $30 / mo</h5>
                </div>
                <div class="card-body d-flex flex-column">
                    <ul>
                        <li>
                            Let Open Assistants handle your project's AI backend
                            <br>
                            <small>
                                The plan includes usage costs, so you wonâ€™t incur extra charges
                                from the AI backend provider (subject to fair use policy)
                            </small>
                        </li>
                        <li>
                            Gain access to advanced management, monitoring, analytics, and testing tools
                        </li>
                    </ul>
                </div>
                <div class="card-footer text-center">
                    <button id="proPlanBtn" class="btn btn-success">Upgrade to Pro Plan</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="checkout">
    <!-- Stripe.js will inserts the payment form here -->
</div>

</div>


{% endblock %}



{% block extra_head %}

    <script src="https://js.stripe.com/v3/"></script>

{% endblock %}


{% block extra_scripts %}

<script>
    const stripe = Stripe('{{ stripe_public_key }}');

    async function initializeCheckout() {
        console.log('Initializing checkout...');

        const fetchClientSecret = async () => {
            console.log('Fetching client secret...');
            try {
                const response = await fetch("{% url 'accounts:payment_session' %}", {
                    method: "POST",
                    headers: {
                        'Content-Type': 'application/json',
                        // Add the CSRF token to the request header
                        'X-CSRFToken': '{{ csrf_token }}',
                    },
                });

                if (!response.ok) {
                    console.error('Error fetching client secret:', response.statusText);
                    return null;
                }

                const { clientSecret } = await response.json();
                console.log('Client secret received:', clientSecret);
                return clientSecret;
            } catch (error) {
                console.error('Error occurred while fetching client secret:', error);
                return null;
            }
        };

        const clientSecret = await fetchClientSecret();

        if (clientSecret) {
            // Initialize Checkout
            console.log('Initializing Stripe Embedded Checkout...');
            try {
                const checkout = await stripe.initEmbeddedCheckout({
                    clientSecret: clientSecret,
                });

                console.log('Mounting Stripe Checkout...');
                checkout.mount('#checkout');
                console.log('Stripe Checkout mounted successfully.');
            } catch (error) {
                console.error('Error initializing or mounting Stripe Checkout:', error);
            }
        } else {
            console.error('Client secret was not retrieved. Cannot initialize checkout.');
        }
    }

    document.getElementById('proPlanBtn').addEventListener('click', async function () {
        console.log('Upgrade to Pro Plan button clicked.');
        // When the button is clicked, initialize and trigger the payment process
        await initializeCheckout();
    });

</script>


{% endblock %}
